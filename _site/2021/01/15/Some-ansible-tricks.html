<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Some ansible tricks | Tib</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Some ansible tricks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Random code and thoughts" />
<meta property="og:description" content="Random code and thoughts" />
<link rel="canonical" href="http://localhost:4000/2021/01/15/Some-ansible-tricks.html" />
<meta property="og:url" content="http://localhost:4000/2021/01/15/Some-ansible-tricks.html" />
<meta property="og:site_name" content="Tib" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-15T18:35:15+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Some ansible tricks" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-15T18:35:15+01:00","datePublished":"2021-01-15T18:35:15+01:00","description":"Random code and thoughts","headline":"Some ansible tricks","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/01/15/Some-ansible-tricks.html"},"url":"http://localhost:4000/2021/01/15/Some-ansible-tricks.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Tib" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Tib</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Some ansible tricks</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-01-15T18:35:15+01:00" itemprop="datePublished">Jan 15, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img src="/assets/images/d1m8edn571qzdthwchxj.png" alt="Ansible" /></p>

<p>In this blog post, I will share some (basic) tricks about Ansible :smiley:</p>

<p>It could possibly prevent you to get bitten :mask:</p>

<h2 id="quote-when-using-vars">Quote when using vars</h2>
<p>When not using variables, you can quote (or not) indifferently:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">foobar</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/tmp/foobar</span>
</code></pre></div></div>

<p>Or (with quotes):</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foobar"</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/tmp/foobar"</span>
</code></pre></div></div>

<p>But as soon as you use variables, you should use quotes!</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/tmp/"</span>
</code></pre></div></div>

<p>Not all ansible versions have the same behaviour for this! Latest versions of Ansible are more flexible, but are not able to completely handle it (depends where the variable is positioned).</p>

<p>For more info, see <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#when-to-quote-variables-a-yaml-gotcha">YAML gotcha</a></p>

<h2 id="extra-quote-when-passing-extra-variable-in-command-line">Extra quote when passing extra variable in command line</h2>
<p>When using the <code class="language-plaintext highlighter-rouge">--extra-vars</code> (or <code class="language-plaintext highlighter-rouge">-e</code>) to pass variables in the command line, take care of adding an extra quote to protect spaces:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                            <span class="c"># here v          and here v</span>
<span class="nv">$ </span>ansible-playbook playbook.yml <span class="nt">-e</span> <span class="s1">'protectme="foo bar"'</span>
                            <span class="c">#     to protect this ^</span>
</code></pre></div></div>

<h2 id="sh-gotcha">sh gotcha</h2>
<p>This is broken:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">servers</span>
  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Broken</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[[</span><span class="nv"> </span><span class="s">-z</span><span class="nv"> </span><span class="s">""</span><span class="nv"> </span><span class="s">]]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">true'</span>
</code></pre></div></div>
<p>Why? Because it is executed by <code class="language-plaintext highlighter-rouge">/bin/sh</code>… not <code class="language-plaintext highlighter-rouge">bash</code> !</p>

<p>You can transform it to a <code class="language-plaintext highlighter-rouge">sh</code> compatible version like this:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">servers</span>
  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Working</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s1">'</span><span class="s">test</span><span class="nv"> </span><span class="s">-z</span><span class="nv"> </span><span class="s">""</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">true'</span>
</code></pre></div></div>

<p>Or specify the executable in the <code class="language-plaintext highlighter-rouge">args</code>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">servers</span>
  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Broken</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[[</span><span class="nv"> </span><span class="s">-z</span><span class="nv"> </span><span class="s">""</span><span class="nv"> </span><span class="s">]]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">true'</span>
    <span class="na">args</span><span class="pi">:</span>
      <span class="na">executable</span><span class="pi">:</span> <span class="s">/bin/bash</span>
</code></pre></div></div>

<h2 id="precedence-of-vars">Precedence of vars</h2>
<p>Some are obvious, but not all :grin:</p>

<p>Here is my reminder:</p>
<ol>
  <li>CLI extra var <code class="language-plaintext highlighter-rouge">-e variable="foo"</code> will override…</li>
  <li>role vars (<code class="language-plaintext highlighter-rouge">roles/common/vars/main.yml</code>) that overrides…</li>
  <li>playbook vars (<code class="language-plaintext highlighter-rouge">playbook.yml</code>) that are taken in priority over…</li>
  <li>role default vars (<code class="language-plaintext highlighter-rouge">roles/common/default/main.yml</code>)</li>
</ol>

<p>For more infos, check the official doc about <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#ansible-variable-precedence">complete list of precedence</a></p>

<h2 id="edit-variable-after-initialization">Edit variable after initialization</h2>

<p>You can do this with the module <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html#ansible-collections-ansible-builtin-set-fact-module">set fact</a>!</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>
  <span class="na">set_fact</span><span class="pi">:</span>
    <span class="na">var1</span><span class="pi">:</span> <span class="s2">"</span><span class="s">new</span><span class="nv"> </span><span class="s">value"</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>That’s all for the tricks.</p>

<p>Happy provisioning! :smiley:</p>

<p><img src="/assets/images/zat57oucm3twctukfnlr.jpeg" alt="Happy provisioning" /></p>

  </div><a class="u-url" href="/2021/01/15/Some-ansible-tricks.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Tib</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Tib</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Random code and thoughts</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
