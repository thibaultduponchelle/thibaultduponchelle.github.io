<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Raku features, community and main interpreter/VM | Tib</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Raku features, community and main interpreter/VM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Random code and thoughts" />
<meta property="og:description" content="Random code and thoughts" />
<link rel="canonical" href="http://localhost:4000/2021/08/19/Raku-features,-community-and-main-interpreter-VM.html" />
<meta property="og:url" content="http://localhost:4000/2021/08/19/Raku-features,-community-and-main-interpreter-VM.html" />
<meta property="og:site_name" content="Tib" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-19T11:29:19+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Raku features, community and main interpreter/VM" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-19T11:29:19+02:00","datePublished":"2021-08-19T11:29:19+02:00","description":"Random code and thoughts","headline":"Raku features, community and main interpreter/VM","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/08/19/Raku-features,-community-and-main-interpreter-VM.html"},"url":"http://localhost:4000/2021/08/19/Raku-features,-community-and-main-interpreter-VM.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Tib" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Tib</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Raku features, community and main interpreter/VM</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-08-19T11:29:19+02:00" itemprop="datePublished">Aug 19, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img src="/assets/images/pys7doytatprcd7n829f.jpg" alt="Some Raku goodies in bulk" /></p>

<p>(This is a translated/improved version of the french article <a href="https://linuxfr.org/news/raku-en-2020">Raku en 2020</a> from the same author)</p>

<p>Thank you to <strong>Elizabeth Mattijsen</strong> who helped to proofread and with advices.</p>

<h2 id="table-of-contents">Table Of Contents</h2>
<ul>
  <li><a href="#about-raku">About Raku</a></li>
  <li><a href="#about-raku-community">Community</a></li>
  <li><a href="#rakudo">Rakudo</a></li>
  <li><a href="#raku-features">Features of the Raku language</a>
    <ul>
      <li><a href="#raku-typing">Typing</a></li>
      <li><a href="#raku-routines">Routines</a></li>
      <li><a href="#raku-operators">Operators</a></li>
      <li><a href="#raku-async">Async, parallel, concurrency</a></li>
      <li><a href="#raku-oop-mop">Object oriented programming and Meta object programming</a></li>
      <li><a href="#raku-grammars">Grammars</a></li>
      <li><a href="#raku-interfacing">Interfacing</a></li>
      <li><a href="#raku-unicode">Unicode</a></li>
      <li><a href="#raku-other">Other</a></li>
    </ul>
  </li>
  <li><a href="#rakudo-implementation">Implementations based on Rakudo</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<p>In this first blog post in a serie of two, you will find a general introduction with some community insights and details about interpreter and VM (<em>Rakudo</em> and <em>MoarVM</em>).</p>

<p>In a second part you get a long description of the Raku features to discover why Raku is worth talking about and learning.</p>

<p>(Next blog post is about past implementations and history details)</p>

<p>This blog post is made with love :heart:</p>

<h2 id="about-raku-">About Raku <a name="about-raku"></a></h2>
<p><del>Perl 6</del> Raku is a programming language powerful and mature that was difficult to implement (which will be described in the second part of this post).</p>

<p>Raku née “Perl 6” is no longer the next version of <strong>Perl 5</strong> (will be Perl 5.36 or Perl 7). Raku has been <strong>renamed in 2019</strong> to clarify this state. But Raku shares a lot with Perl 5:</p>

<ul>
  <li>some technical characteristics (close to natural language, <a href="https://en.wikipedia.org/wiki/Sigil_(computer_programming)">sigils</a>…)</li>
  <li>the same <a href="https://www.perlfoundation.org/">foundation</a></li>
  <li>the same conferences (but Raku had its first <a href="https://conf.raku.org/">dedicated conference</a> recently)</li>
  <li>partly their communities (Damian Conway, Larry Wall…)</li>
  <li>some events (<a href="https://perlweeklychallenge.org/">Perl Weekly Challenge</a>…)</li>
</ul>

<p>Lately, Raku has become too different from Perl 5 that we can simply say “Perl” to designate Perl 5 (or Perl 7) and we would prefer “Raku” in any circumstances to talk about Perl 6. There was a time where Perl 6 community was slightly against this renaming, but the overall opinion changed and the renaming was done smoothly between 2018 and 2019 (see next blog post of the série for more details).</p>

<p>You can follow Raku news by subscribing to the newsletter <a href="https://rakudoweekly.blog/">Rakudo Weekly News</a>.</p>

<p>Raku has a small community but some “<em>killer apps</em>”:</p>
<ul>
  <li>its IDE “<a href="https://commaide.com/">Comma</a>”</li>
  <li><a href="https://cro.services/">Cro</a>, a toolbox for the web (applications, services)</li>
  <li><a href="https://github.com/melezhik/Sparrow6">Sparrow</a> an automation framework, and its <a href="http://sparrowhub.io/">modules</a></li>
  <li>a (small) <a href="https://modules.raku.org/">CPAN</a></li>
</ul>

<h2 id="big-names-from-raku-world-">Big names from Raku world <a name="about-raku-community"></a></h2>
<p>Before going into details of renaming and Raku versions, let’s hightlight some past and present big contributors to Raku:</p>

<ul>
  <li><strong>Jonathan Worthington</strong>: Current lead developer of Rakudo (<a href="http://www.josetteorama.com/all-about-perl-6-interview-of-jonathan-worthington-part-1-of-3/">interview</a>)</li>
  <li><strong>Elizabeth Mattijsen</strong>: very involved in Raku</li>
  <li><strong>Patrick Michaud</strong>: former lead deveoper of Rakudo, NQP, etc….</li>
  <li><strong>Audrey Tang</strong>: currently Taïwan minister (!), formerly main developer of Pugs (Perl 6 implementation in Haskell, see this <a href="http://www.perlcast.com/2006/03/interview-with-audrey-tang.html">old interview</a> or this <a href="https://andrewshitov.com/2015/05/05/interview-with-audrey-tang/">interview</a>)</li>
  <li><strong>Damian Conway</strong>: teacher, speaker, spokesperson and prolific developer</li>
  <li><strong>Larry Wall</strong>: creator of Perl (BDFL) and creator of Raku. No need to present him! In 2021, no longer involved.</li>
  <li><strong>Moritz Lenz</strong>: writer and big contributor</li>
  <li><strong>Flavio S. Glock</strong>: lead developer of Perlito</li>
</ul>

<p>Not all are still active and the list is not exhaustive!</p>

<p>The Raku community decided recently to setup a <a href="https://github.com/Raku/Raku-Steering-Council/blob/main/announcements/20200720.md">steering council</a>.</p>

<h2 id="rakudo-">Raku(do) <a name="rakudo"></a></h2>
<p>The most advanced implementation of Raku is <strong>Rakudo</strong> (interpreter) with <strong>NQP</strong> (builtins) on <strong>MoarVM</strong> (virtual machine).</p>

<p>When Rakudo is released, the bundle <strong>Rakudo + MoarVM</strong> is called <strong>Rakudo Star</strong> (or <strong>Rakudo *</strong>) :star:</p>

<p>Since 2015, the implementation of Raku is “features-complete” and the effort on the compiler and VM are more about fixing issues and improving performances.</p>

<p>Raku had multiple official releases (the most important being in 2015) :</p>

<ul>
  <li>first public version of <strong>Rakudo *</strong> in july 2010 (major version but not feature-complete, still based on Parrot → Rakudo + Parrot)</li>
  <li><strong>6.c</strong> “Christmas” in 2015 (<a href="https://perl6advent.wordpress.com/2015/12/25/christmas-is-here/">announcement</a>) (Rakudo + MoarVM)</li>
  <li><strong>6.d</strong> “Diwali” in november 2019 (<a href="https://github.com/Raku/roast/blob/master/docs/announce/6.d.md">details of the several changes</a>) (Rakudo + MoarVM)</li>
  <li><strong>6.e</strong> will be the next major version (Rakudo + MoarVM).</li>
</ul>

<p>From where comes this versioning scheme?</p>

<p>Simply from a <a href="https://youtu.be/FP1IfvAUJnI">recurring joke</a> about the release date of Raku. It was common to answer “will be ready for christmas” :grinning:</p>

<p>In addition to major version, the team working on Raku produces monthly minor versions.</p>

<h2 id="some-books">Some books</h2>
<p>Before going into language details, here are some books to help you learn more about Raku:</p>

<ul>
  <li><a href="https://www.oreilly.com/library/view/perl-6-essentials/0596004990/">Perl 6 Essentials</a></li>
  <li><a href="https://www.oreilly.com/library/view/learning-perl-6/9781491977675/">Learning Perl 6</a></li>
  <li><a href="https://www.oreilly.com/library/view/think-perl-6/9781491980545/">Think Perl 6</a></li>
  <li><a href="https://www.oreilly.com/library/view/perl-6-quick/9781484249567/">Perl 6 quick syntax reference</a></li>
  <li><a href="https://www.oreilly.com/library/view/perl-6-deep/9781787282049/">Perl 6 deep dive</a></li>
  <li><a href="https://www.oreilly.com/library/view/raku-fundamentals/9781484261095/">Raku fundamentals</a></li>
</ul>

<h2 id="some-links">Some links</h2>
<ul>
  <li><a href="https://repl.it/languages/raku">Test Raku online</a></li>
  <li><a href="https://www.raku.org/">Raku official website</a></li>
  <li><a href="https://rakudo.org/">Rakudo</a></li>
  <li><a href="https://www.moarvm.org/">MoarVM</a></li>
</ul>

<p>The technical details starts here, I hope you’re ready :grinning:</p>

<h2 id="the-power-of-raku-">The power of Raku <a name="raku-features"></a></h2>
<p>Raku features are impressive, I wanted to start by this :)</p>

<p>Raku takes roots from the linguistic skills from Larry Wall, therefore Raku is very influenced by natural language. Raku is multi-paradigm (procedural, functional, concurrency programming and object oriented).</p>

<p>The values of Raku can be found in the Raku manifesto (<a href="https://www.codesections.com/blog/raku-manifesto/">1</a>,  <a href="https://www.codesections.com/blog/raku-manifesto-2/">2</a>, <a href="https://www.codesections.com/blog/raku-manifesto-3/">3</a>)</p>

<p>Like its cousin Perl:</p>
<ul>
  <li>it’s a rich language with a notion of <a href="https://docs.raku.org/language/contexts">context</a></li>
  <li>its regular expressions are very powerful and Raku even integrates grammar handling directly in the language (!)</li>
  <li>it has a <a href="https://modules.raku.org/t/CPAN">CPAN</a>.</li>
</ul>

<p>Contrary to Perl 5:</p>
<ul>
  <li>interfacing with native code is deadly simple</li>
  <li>oriented object programming is integrated in the language (framework + object types)</li>
  <li>the language can deal with concurrency and provides a full toolbox for it</li>
  <li>Unicode is handled “by default”</li>
</ul>

<p>For more technical details, here is the <a href="https://docs.raku.org/language/glossary">Raku glossary</a> and also a <a href="http://web.archive.org/web/20150801100611/http://www.perl6.org/compilers/features">features comparison between the compilers</a> (it gives a good overview of the language). In the coming paragraphs, the Raku features are explained more in detail.</p>

<p>Courses like <a href="https://course.raku.org">courses.raku.org</a> or <a href="https://raku.guide">raku.guide</a> are probably good “showcases” of Raku features.</p>

<h3 id="typing-">Typing <a name="raku-typing"></a></h3>
<ul>
  <li>Gradual typing (dynamic and static typing):
```perl
    <h1 id="dynamic">Dynamic</h1>
    <p>my Cool $var = 42;</p>
  </li>
</ul>

<h1 id="functions-using-var-will-coerce-to-another-type">Functions using $var will coerce to another type</h1>
<h1 id="upon-their-needs">upon their needs</h1>

<h1 id="static">Static</h1>
<p>my Str $var = “Raku”;</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Annotation in signatures:
```perl
sub ab(Int $a, Int $b) { return $a+$b; }; 
say ab(1,1);
</code></pre></div></div>

<ul>
  <li>Type inference</li>
  <li>Allomorphs (and polymorphic evaluation): <code class="language-plaintext highlighter-rouge">IntStr $foo</code></li>
  <li>Junctions:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$junction</span> <span class="o">=</span> <span class="mi">1</span><span class="o">|</span><span class="mi">2</span><span class="o">|</span><span class="mi">3</span><span class="p">;</span>
<span class="nv">$junction</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1"># junction now equals 5|6|7</span>
<span class="nv">$junction</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">);</span> <span class="c1"># junction now equals (6|7|8)&amp;(7|8|9)</span>
</code></pre></div>    </div>
  </li>
  <li><a href="https://perl6advent.wordpress.com/2016/12/08/how-to-make-use-and-abuse-perl-6-subsets/">Subsets</a>: allow to extend isomorphic classes, can be used as constraints, while being resolved at runtime:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">subset</span> <span class="nv">Even</span> <span class="nv">where</span> <span class="o">*</span> <span class="o">%%</span> <span class="mi">2</span><span class="p">;</span>  
<span class="nv">say</span> <span class="mi">1</span> <span class="o">~~</span> <span class="nv">Even</span><span class="p">;</span> <span class="c1"># False</span>
</code></pre></div>    </div>
  </li>
  <li>Coercion:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">i</span><span class="p">-cast(Int() $n) {</span> <span class="nv">say</span> <span class="nv">$n</span><span class="o">.^</span><span class="nv">name</span> <span class="p">};</span> 
<span class="nv">i</span><span class="o">-</span><span class="nv">cast</span> <span class="p">"</span><span class="s2">42</span><span class="p">";</span>
</code></pre></div>    </div>
  </li>
  <li><a href="https://docs.raku.org/type/Signature#Coercion_type">Coercion in signatures (constraints)</a></li>
</ul>

<p>Constraints + coercion (“I want a string object and I <em>cast</em> into integer object”):</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">f</span><span class="p">(Int(Str) $want-str-cast-to-int, Str() $cast-to-str) {</span> <span class="p">}</span> <span class="p">;</span>
<span class="nv">f</span> <span class="p">'</span><span class="s1">10</span><span class="p">',</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Or conditional constraints (“my argument should be an integer object or a string object”):</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">xyz</span><span class="p">($n where $_ ~~ Int | Str ) {</span> <span class="nv">say</span> <span class="o">+</span><span class="nv">$n</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Native types:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">int8</span> <span class="nv">$verysmall</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> 
<span class="nv">say</span> <span class="nv">$verysmall</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>Auto‑boxing : automatic conversion from native type to object</li>
  <li>Auto‑vivification in the hash/arrays:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">%a</span><span class="p">;</span> 
<span class="nv">%a</span><span class="p">{'</span><span class="s1">autovivification</span><span class="p">'}</span><span class="o">++</span><span class="p">;</span> 
<span class="nv">say</span> <span class="nv">%a</span><span class="p">{'</span><span class="s1">autovivification</span><span class="p">'};</span>
</code></pre></div>    </div>
  </li>
  <li><a href="https://docs.raku.org/language/variables#Twigils">Twigils</a> (!) for instance to define the variable scope</li>
  <li>A full <a href="https://docs.raku.org/language/setbagmix">collection of objects containers</a>. See the <a href="https://docs.raku.org/type-composite.html">list of composite types</a> (SetHash, Bag, Map, list, Mix, Pair, Set…)</li>
  <li>Shaped array/hashes (a kind of matrix or multi dimension hash)</li>
  <li>Compact arrays: <code class="language-plaintext highlighter-rouge">my int @array</code> which is stored in a contiguous manner</li>
  <li><a href="https://medium.com/@jcoterhals/perl-6-small-stuff-5-gather-around-its-time-to-get-lazy-but-why-da20fdb18a3b">Lazy lists</a> (see also <code class="language-plaintext highlighter-rouge">gather</code>):
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">@list</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span> <span class="o">+</span> <span class="o">*</span> <span class="o">...</span> <span class="o">*</span><span class="p">)</span><span class="o">.</span><span class="nb">grep</span><span class="p">({</span> <span class="vg">$_</span><span class="o">.</span><span class="nv">is</span><span class="o">-</span><span class="nv">prime</span> <span class="p">});</span>
<span class="nv">say</span> <span class="nv">@list</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1"># This generates elements 0..4. </span>
<span class="c1"># Elements 5..∞ haven't been generated yet</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="routines-">Routines <a name="raku-routines"></a></h3>
<ul>
  <li>Argument:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">plus2</span><span class="p">($foo) {</span> <span class="k">return</span> <span class="nv">$foo</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Typed:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">mul3</span><span class="p">(Int $foo) {</span> <span class="k">return</span> <span class="nv">$foo</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>With attribute <em>rw</em> or <em>copy</em>:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">make42</span><span class="p">($foo is rw) {</span> <span class="nv">$foo</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Multi‑dispatch:
    <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">multi</span> <span class="k">sub </span><span class="nf">sayit</span><span class="p">( Int $n ) {</span> <span class="nv">say</span> <span class="p">"</span><span class="s2">Number: </span><span class="si">$n</span><span class="p">";</span> <span class="p">}</span> 
<span class="nv">multi</span> <span class="k">sub </span><span class="nf">sayit</span><span class="p">( Str $s ) {</span> <span class="nv">say</span> <span class="p">"</span><span class="s2">String: </span><span class="si">$s</span><span class="p">";</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>The dispatch is based on the number of arguments, their types, the constraints (we can even play with it with functions <code class="language-plaintext highlighter-rouge">nextsame</code>, <code class="language-plaintext highlighter-rouge">nextwith</code>, <code class="language-plaintext highlighter-rouge">callsame</code>, <code class="language-plaintext highlighter-rouge">callwith</code>).
See also “<em>Proper narrowness analysis</em>” for the best candidate resolution.</p>

<ul>
  <li>Slurp of remaining arguments and flattening of arguments (like in Perl 5).</li>
</ul>

<h3 id="operators-">Operators <a name="raku-operators"></a></h3>
<ul>
  <li>Raku has a big number of operators, see the full list:
<img src="/assets/images/mk66pcc34k85yfb2lfcb.jpg" alt="Periodic table of the operators" /></li>
  <li>Raku can be easily extended (see <a href="https://docs.raku.org/language/operators">documentation of the operators</a>)</li>
  <li><a href="https://6guts.wordpress.com/2011/10/15/an-optimizer-lands-bringing-native-operators/">native operators</a>
 (with inline or explicit optimizations)</li>
  <li>operators can even be in UTF-8</li>
</ul>

<h3 id="async-parallelism-and-concurrency-">Async, parallelism and concurrency <a name="raku-async"></a></h3>
<p>A full toolbox to handle <a href="http://doc.perl6.org/language/concurrency">asynchronous, parallelism and concurrency</a> :</p>
<ul>
  <li><a href="https://docs.raku.org/language/concurrency#Promises">promises (or future)</a> usable with <a href="https://docs.raku.org/language/concurrency#Proc::Async">Proc::Async</a> for external calls</li>
  <li>streams handling with <a href="https://docs.raku.org/language/concurrency#Channels">Channel</a> and <a href="https://docs.raku.org/language/concurrency#Supplies">Supplies</a> to implement <em>event driven</em> or <em>patterns publish/subscribe</em> </li>
  <li>an access to low level primitives like <a href="https://docs.raku.org/language/concurrency">threads, scheduler and locks</a></li>
</ul>

<h3 id="object-oriented-programming-and-meta-object-programming-">Object oriented programming and Meta object programming <a name="raku-oop-mop"></a></h3>
<p>Ability to define our own operators (seen above) and features. The <em>meta object programming</em> is partially handled in the virtual machine:</p>
<ul>
  <li>single or multiple inheritance</li>
  <li>introspection</li>
  <li>“edit” a class after instantiation (<a href="https://gist.github.com/draegtun/276591">example</a>)</li>
  <li><a href="https://perl6advent.wordpress.com/2011/12/14/meta-programming-what-why-and-how/">composition/encapsulation</a> of methods</li>
  <li><a href="https://docs.raku.org/type/Metamodel::Trusting">trust relationship</a> which allows access to private methods of another (parent) class without making them inherit</li>
  <li><a href="https://laurent-rosenfeld.developpez.com/tutoriels/perl/perl6/objets/#L2-6">delegations</a> <code class="language-plaintext highlighter-rouge">has $.base is rw handles &lt;meth1 meth2&gt;</code></li>
  <li>type <strong>whatever</strong> “*” (which gave its name to the cast “Rakudo star”)</li>
</ul>

<h3 id="grammars-">Grammars <a name="raku-grammars"></a></h3>
<p>Support for <a href="https://docs.raku.org/language/grammars">grammars</a> (<code class="language-plaintext highlighter-rouge">grammar</code>,<code class="language-plaintext highlighter-rouge"> token</code>, <code class="language-plaintext highlighter-rouge">rule</code>,<code class="language-plaintext highlighter-rouge"> regex</code>) in the language!</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">grammar</span> <span class="nv">Calculator</span> <span class="p">{</span>
    <span class="nv">token</span> <span class="nv">TOP</span> <span class="p">{</span> <span class="o">&lt;</span><span class="nv">calc</span><span class="o">-</span><span class="nv">op</span><span class="o">&gt;</span> <span class="p">}</span>
 
    <span class="nv">proto</span> <span class="nv">rule</span> <span class="nv">calc</span><span class="o">-</span><span class="nv">op</span>          <span class="p">{</span><span class="o">*</span><span class="p">}</span>
          <span class="nv">rule</span> <span class="nv">calc</span><span class="o">-</span><span class="nv">op:sym</span><span class="o">&lt;</span><span class="nv">add</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span> <span class="p">'</span><span class="s1">+</span><span class="p">'</span> <span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span> <span class="p">}</span>
          <span class="nv">rule</span> <span class="nv">calc</span><span class="o">-</span><span class="nv">op:sym</span><span class="o">&lt;</span><span class="nv">sub</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span> <span class="p">'</span><span class="s1">-</span><span class="p">'</span> <span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span> <span class="p">}</span>
 
    <span class="nv">token</span> <span class="nv">num</span> <span class="p">{</span> <span class="o">\</span><span class="nv">d</span><span class="o">+</span> <span class="p">}</span>
<span class="p">}</span>
 
<span class="nv">class</span> <span class="nv">Calculations</span> <span class="p">{</span>
    <span class="nv">method</span> <span class="nv">TOP</span>              <span class="p">(</span><span class="vg">$/</span><span class="p">)</span> <span class="p">{</span> <span class="nv">make</span> <span class="err">$</span><span class="o">&lt;</span><span class="nv">calc</span><span class="o">-</span><span class="nv">op</span><span class="o">&gt;.</span><span class="nv">made</span><span class="p">;</span> <span class="p">}</span>
    <span class="nv">method</span> <span class="nv">calc</span><span class="o">-</span><span class="nv">op:sym</span><span class="o">&lt;</span><span class="nv">add</span><span class="o">&gt;</span> <span class="p">(</span><span class="vg">$/</span><span class="p">)</span> <span class="p">{</span> <span class="nv">make</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="err">$</span><span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span><span class="p">;</span> <span class="p">}</span>
    <span class="nv">method</span> <span class="nv">calc</span><span class="o">-</span><span class="nv">op:sym</span><span class="o">&lt;</span><span class="nv">sub</span><span class="o">&gt;</span> <span class="p">(</span><span class="vg">$/</span><span class="p">)</span> <span class="p">{</span> <span class="nv">make</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="err">$</span><span class="o">&lt;</span><span class="nv">num</span><span class="o">&gt;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
 
<span class="nv">say</span> <span class="nv">Calculator</span><span class="o">.</span><span class="nv">parse</span><span class="p">('</span><span class="s1">2 + 3</span><span class="p">',</span> <span class="s">actions</span> <span class="o">=&gt;</span> <span class="nv">Calculations</span><span class="p">)</span><span class="o">.</span><span class="nv">made</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="interfacing-">Interfacing <a name="raku-interfacing"></a></h3>
<p>Native language support is really very easy!</p>

<ul>
  <li>Easy interfacing with native languages (<em>Native Call</em>):
```perl
use NativeCall;</li>
</ul>

<h1 id="interface-a-function-from-unistdh">Interface a function from unistd.h</h1>
<p>sub getpagesize() returns int32 is native {};</p>

<h1 id="interface-a-function-from-a-shared-library-eg-libcalculatorso">Interface a function from a shared library (e.g. libcalculator.so)</h1>
<p>sub add(int32, int32) returns int32 is native(“calculator”) {};</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
- Interfacing with Perl 5 with [Inline::Perl5](https://github.com/niner/Inline-Perl5):
```perl
use Test::More:from&lt;Perl5&gt;;
plan tests =&gt; 1;

use Inline::Perl5;
my $p5 = Inline::Perl5.new;
$p5.call('print', 'Hello World');
</code></pre></div></div>

<h3 id="unicode-processed-at-the-grapheme-level-">Unicode processed at the grapheme level <a name="raku-unicode"></a></h3>
<p>Very high level of Unicode management, in particular thanks to primitives in the MoarVM virtual machine.</p>

<p>The language operators themselves can be UTF-8 (like the ones you create).</p>

<h3 id="other-bulk-features-">Other bulk features <a name="raku-other"></a></h3>
<ul>
  <li><a href="https://andrewshitov.com/2018/10/31/anonymous-code-blocks-in-perl-6/">Pointy arrow block</a> (anonymous closure):</li>
</ul>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$cube</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="nv">$x</span> <span class="p">{</span><span class="nv">$x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">};</span>
<span class="nv">say</span> <span class="nv">$cube</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1"># 27</span>
</code></pre></div></div>

<ul>
  <li><a href="https://andrewshitov.com/2018/10/31/placeholders-in-perl-6/">Placeholders</a></li>
</ul>

<p>By Alphabetic order:</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$pow</span> <span class="o">=</span> <span class="p">{</span><span class="err">$</span><span class="o">^</span><span class="nv">x</span> <span class="o">**</span> <span class="err">$</span><span class="o">^</span><span class="nv">y</span><span class="p">};</span>
<span class="nv">say</span> <span class="nv">$pow</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c1"># 81</span>
</code></pre></div></div>

<p>Or even:</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="mi">0</span><span class="o">..</span><span class="mi">9</span> <span class="p">{</span>
    <span class="nv">say</span> <span class="p">"</span><span class="s2">$^n2, $^n1</span><span class="p">";</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Or with naming :</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$pow</span> <span class="o">=</span> <span class="p">{</span><span class="err">$</span><span class="p">:</span><span class="nv">base</span> <span class="o">**</span> <span class="err">$</span><span class="p">:</span><span class="nb">exp</span><span class="p">};</span>
<span class="nv">say</span> <span class="nv">$pow</span><span class="p">(:</span><span class="nv">base</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="p">:</span><span class="nb">exp</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1"># 625</span>
</code></pre></div></div>

<h1 id="rakudo-star-from-2010-">Rakudo Star (from 2010) <a name="rakudo-implementation"></a></h1>
<p>The first major version of Rakudo Star (or “Rakudo *”) was based on Parrot (PCT + ParrotVM), but we will ignore this version to focus on the current implementation (Rakudo + MoarVM).</p>

<h2 id="compilation-rakudo">Compilation (Rakudo)</h2>
<p><strong>Rakudo</strong> is a compiler for Raku that implements the entire language and can target several different VMs (the main one being MoarVM). Most of Rakudo is written in “simplified Raku” (NQP). Rakudo also implements precompilation to optimize its performance. In addition to that, Rakudo improves the syntax tree using several optimization methods, here are some examples:</p>

<ul>
  <li>the converted <em>range</em> iterations are in native loops</li>
  <li>de-virtualization of private methods with compile-time resolution</li>
  <li>removal of (statically) dead code</li>
  <li>anonymize a variable</li>
  <li>reduce the scope of a variable</li>
  <li>unfolding of the junctions</li>
</ul>

<h3 id="nqp">NQP</h3>
<p><a href="https://github.com/Raku/nqp">NQP</a> is a compiler like MiniPerl for Perl 5. It is a <em>bootstrapping</em> tool which helps to compile the Raku parts of Rakudo and compile the libraries before running have compiled the libraries. Unlike MiniPerl for Perl 5 (which is an interpreter that can interpret all Perl syntax but miss some <em>batteries</em>: means without modules mixing Perl code and native code), NQP can only compile a “simplified Raku”. NQP refers to both the compiler and the source code contained in files with the “.nqp” extension.</p>

<p>Some NQP code looks like this:</p>
<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">method</span> <span class="nv">symtable</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%!</span><span class="nv">symbol</span> <span class="p">:</span><span class="o">=</span> <span class="nn">nqp::</span><span class="nv">hash</span><span class="p">()</span> <span class="k">if</span> <span class="nn">nqp::</span><span class="nv">isnull</span><span class="p">(</span><span class="o">%!</span><span class="nv">symbol</span><span class="p">);</span>
    <span class="o">%!</span><span class="nv">symbol</span>
<span class="p">}</span>

<span class="nv">method</span> <span class="nv">evaluate_unquotes</span><span class="p">(</span><span class="nv">@unquotes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$result</span> <span class="p">:</span><span class="o">=</span> <span class="nv">self</span><span class="o">.</span><span class="nv">shallow_clone</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$elems</span> <span class="p">:</span><span class="o">=</span> <span class="nn">nqp::</span><span class="nv">elems</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="nv">self</span><span class="p">));</span>
    <span class="k">while</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$elems</span> <span class="p">{</span>
        <span class="nv">$result</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="nv">self</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">.</span><span class="nv">evaluate_unquotes</span><span class="p">(</span><span class="nv">@unquotes</span><span class="p">);</span>
        <span class="nv">$i</span> <span class="p">:</span><span class="o">=</span> <span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$result</span>
<span class="p">}</span>
</code></pre></div></div>

<p>NQP is part of Rakudo and seems inspired from MiniPerl6/KindaPerl6.</p>

<p>Perlito (see below) also implements the same kind of “simplified Raku”.</p>

<h2 id="execution-moarvm">Execution (MoarVM)</h2>
<p><a href="https://github.com/MoarVM/MoarVM">MoarVM</a> stands for <em>Metamodel On A Runtime VM</em> (<a href="https://www.moarvm.org/index.html">official site</a>). It’s a registrers-based virtual machine like Parrot. <a href="https://github.com/jnthn">Jonathan Worthington</a> is the founder and architect of MoarVM.</p>

<p>Here are some features of MoarVM:</p>
<ul>
  <li>internal representation closer to Raku (compared to Parrot) (“<em>On the other hand, there are features that are hard to implement efficiently if the VM doesn’t support it.</em>”, according to an <a href="https://andrewshitov.com/2015/05/15/interview-with-flavio-glock/">interview with Flavio Glock </a>);</li>
  <li>superb Unicode support, with strings represented at the grapheme level</li>
  <li>management of asynchronous and concurrent programming with control structures for concurrent programming, synchronous sockets, timers, processes, semaphores, blocking queues, etc.</li>
  <li>precise garbage collection, generational (young → <a href="http://www.cs.cornell.edu/courses/cs312/2003fa/lectures/sec24.htm"><em>semispace</em></a> and old → <em>big buckets</em>) and managing the competition</li>
  <li>able to manage continuations</li>
  <li><a href="https://6guts.wordpress.com/2012/02/10/bounded-serialization-better-regexes-and-better-errors/">bounded serialization</a>, serialize the code of the loaded modules for later and save start-up time by avoiding reconstructing the intermediate representations of this code</li>
  <li>runtime loading of code</li>
  <li>optimizations: <em>tail call</em> eliminations (do not stack in the call stack if the function return is in the call), <em>dispatch</em>, elimination of dead code, <em>on stack replacement</em> (replacement on the routine stack not optimized by a routine optimized), <em><a href="https://en.wikipedia.org/wiki/Escape_analysis">escape analysis</a></em> (transform heap allocations into allocation on the stack or even in a register) and <em>scalar replacement</em> (eliminate memory allocations)</li>
  <li>JIT compilation</li>
  <li>profiling of the call stack and allocations</li>
  <li><a href="https://6guts.wordpress.com/2016/03/21/a-whole-heap-of-work/">heap snapshotting</a>: mainly for further scans (investigation and improvement of garbage collection, for example)</li>
</ul>

<p>I also recommend reading this <a href="http://brrt-to-the-future.blogspot.com/2014/05/moarvm-as-machine.html">introduction to MoarVM</a>.</p>

<h3 id="mast">MAST</h3>
<p>MAST stands for <em>MoarVM AST</em> (Abstract Syntax Tree).</p>

<h3 id="mbc">MBC</h3>
<p>MBC stands for <em>MoarVM Byte Code</em>. Here what looks like MBC:</p>

<pre><code class="language-asm">; Grab value out of Scalar
decont r4, r1 

; Grab type ; de-Scalar if needed
wval r5, 1, 34
decont r3, r5

; Ensure arg is an Int
istype r6, r4, r3
assertparamcheck r6
</code></pre>

<h2 id="implementation-based-on-rakudo--moarvm-since-2012">Implementation based on Rakudo + MoarVM (since 2012)</h2>
<p>MoarVM does not have an assembler.</p>

<p><img src="/assets/images/2syw2b00dpqrg0s6038w.png" alt="Rakudo Moar" /></p>

<p>Below is another architecture diagram taken from a presentation on Rakudo/MoarVM optimizations (2014):
<img src="/assets/images/vpq3t6jridlegh6750ni.png" alt="Rakudo Architecture" /></p>

<h1 id="conclusion-">Conclusion <a name="conclusion"></a></h1>
<p>This first blog post treated more about <em>current</em> information about Raku.</p>

<p>I hope it gave you the envy to try it :kissing_heart:</p>

<p>Next blog post will dig into historical bits of Raku (and implementation archeology) with several technical sketches :dancer:</p>

<p>It took me a lot of time to gather these traces of a dead world, but believe me it’s very interesting so just let yourself be guided!</p>

  </div><a class="u-url" href="/2021/08/19/Raku-features,-community-and-main-interpreter-VM.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Tib</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Tib</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Random code and thoughts</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
